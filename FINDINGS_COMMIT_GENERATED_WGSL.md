# Findings: Commit Generated WGSL Policy Implementation

**Date**: 2026-01-12
**Scope**: Verify and document the "commit generated WGSL" policy for cfd2

## Executive Summary

✅ **The policy is correctly implemented**: Generated WGSL files are committed to version control and there is no runtime generation.

⚠️ **Minimal guardrails needed**: While the policy is working, automated CI checks would prevent accidental drift.

## Policy Status: ✅ CONFIRMED

### What We Found

1. **Generated files ARE committed** ✓
   - All 19 generated `.wgsl` files in `src/solver/gpu/shaders/generated/` are tracked in git
   - Current git status shows 2 newly added files (expected for recent work)

2. **No runtime generation** ✓
   - All shader generation happens exclusively in `build.rs`
   - Runtime only consumes pre-generated shaders via embedded constants
   - No dynamic WGSL string construction at runtime

3. **Deterministic generation** ✓
   - `build.rs` uses `write_if_changed()` to avoid unnecessary file updates
   - Generation is reproducible across builds
   - Same inputs → same outputs

4. **Bindings embed shader source** ✓
   - `wgsl_bindgen` embeds all shader source as `SHADER_STRING` constants
   - Shaders are compiled into the binary
   - No file I/O at runtime for shader loading

## Generation Pipeline Architecture

### Build-time Flow (build.rs)

```
Model Definitions (src/solver/model/)
         ↓
    Codegen (src/solver/codegen/emit.rs)
         ↓
    WGSL Generation
         ↓
    src/solver/gpu/shaders/generated/*.wgsl (COMMITTED)
         ↓
    wgsl_bindgen
         ↓
    src/solver/gpu/bindings.rs (COMMITTED)
         ├─ Embedded SHADER_STRING constants
         └─ Pipeline constructor functions
         ↓
    Build-time Registry Generation (to OUT_DIR)
         ├─ generic_coupled_registry.rs
         ├─ kernel_registry_map.rs
         └─ wgsl_binding_meta.rs
```

### Runtime Flow

```
Application Startup
       ↓
  kernel_registry::kernel_source_by_id()
       ↓
  Lookup in generated tables (from OUT_DIR includes)
       ↓
  Return: bindings::SHADER_STRING + create_pipeline
       ↓
  GPU pipeline creation (from embedded source)
```

### Key Observations

- **Zero runtime codegen**: No `emit_*` functions called at runtime
- **All paths go through build.rs**: Changes to codegen logic trigger rebuild
- **Type safety**: Generated Rust bindings are compile-time checked
- **No divergence risk**: Build must succeed before binary runs

## Files Analyzed

### Generation Sources
- `build.rs:373-409` - Main generation entry points
- `src/solver/codegen/emit.rs` - WGSL emission functions
- `src/solver/codegen/method_ei.rs` - EI kernel generators
- `src/solver/codegen/generic_coupled_kernels.rs` - Generic coupled generators
- Various `src/solver/codegen/*.rs` - Term/method-specific generators

### Generated Outputs (Committed)
- `src/solver/gpu/shaders/generated/*.wgsl` (19 files)
- `src/solver/gpu/bindings.rs` (generated by wgsl_bindgen)

### Runtime Consumption
- `src/solver/gpu/lowering/kernel_registry.rs` - Runtime kernel lookup
- `src/solver/gpu/bindings.rs` - Embedded shader constants

### Build-time Metadata (Ephemeral, in OUT_DIR)
- `generic_coupled_registry.rs` - Model-specific kernel pairs
- `kernel_registry_map.rs` - KernelId → pipeline mapping
- `wgsl_binding_meta.rs` - Binding descriptors

## Current Guardrails

### Existing Protection Mechanisms ✓

1. **Build-time validation**
   - Codegen errors cause `build.rs` to panic → build fails
   - Cannot produce a binary with stale/missing shaders

2. **Deterministic generation**
   - `write_if_changed()` prevents spurious diffs
   - Same codegen logic → same output

3. **Type safety**
   - `wgsl_bindgen` generates typed Rust bindings
   - Binding mismatches caught at compile time
   - Layout assertions verify struct compatibility

4. **Version control**
   - Git tracks all generated `.wgsl` files
   - Changes visible in PRs for review

### Gaps (Minor)

1. **No CI enforcement**
   - Nothing prevents merging a PR with stale generated files
   - Developer could forget to run `cargo build` before committing

2. **No pre-commit validation**
   - Local commits could include stale files
   - Would only be caught during review or CI

## Recommended Minimal Guardrails

### 1. CI Check (High Priority) ✅ PROVIDED

**Script**: `scripts/check_generated_wgsl.sh`

Add to CI workflow:

```yaml
# Example: .github/workflows/ci.yml
jobs:
  check-codegen:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions-rs/toolchain@v1
      - name: Verify generated WGSL is up to date
        run: ./scripts/check_generated_wgsl.sh
```

**What it does**:
- Regenerates all WGSL files via `cargo build`
- Diffs against committed versions
- Fails if any differences found

**Impact**: Prevents merging stale generated files

### 2. Documentation (High Priority) ✅ PROVIDED

**File**: `GENERATED_WGSL_POLICY.md`

**Contents**:
- Policy statement
- Rationale
- Generation pipeline diagram
- Developer workflow
- Troubleshooting guide

**Impact**: Onboards new developers, documents invariants

### 3. Pre-commit Hook (Optional)

```bash
#!/bin/sh
# .git/hooks/pre-commit
./scripts/check_generated_wgsl.sh
```

**Impact**: Catches issues locally before push

**Trade-off**: Adds ~3-5s to commit time (build overhead)

## Testing the Guardrails

Verification script tested successfully:

```bash
$ ./scripts/check_generated_wgsl.sh
Checking that generated WGSL files are up to date...
Regenerating WGSL files...
Comparing generated files...
✓ All generated WGSL files are up to date
```

## Risks & Mitigations

### Risk: Forgetting to Commit Generated Files

**Likelihood**: Low (build.rs fails without them)
**Impact**: Build breaks, easy to fix
**Mitigation**: CI check (recommended), pre-commit hook (optional)

### Risk: Merge Conflicts in Generated Files

**Likelihood**: Medium (generated files change frequently)
**Impact**: Low (regenerate after resolving source conflicts)
**Mitigation**: Document workflow in policy doc ✓

### Risk: Generated Files Drift from Source

**Likelihood**: Very Low (build.rs regenerates deterministically)
**Impact**: Medium (confusing errors)
**Mitigation**: CI check (recommended) ✓

### Risk: Build.rs Bugs Produce Bad Output

**Likelihood**: Low (tested extensively)
**Impact**: High (runtime crashes)
**Mitigation**: Existing test suite, type-safe bindings ✓

## Alignment with CODEGEN_PLAN.md

The current policy aligns with the codegen plan's goals:

✓ **No runtime compilation**: Plan specifies "Generated-per-model WGSL stays (no runtime compilation)" - CONFIRMED

✓ **Deterministic generation**: Build.rs generates consistently - CONFIRMED

✓ **Stable build artifacts**: Generated files are version-controlled - CONFIRMED

⚠️ **Future work**: Plan mentions eventual IR-driven codegen, but the commit policy will remain unchanged

## Recommendations

### Immediate Actions (High Value, Low Effort)

1. ✅ **Add CI check** (provided: `scripts/check_generated_wgsl.sh`)
   - Prevents merging stale files
   - ~1 minute CI job
   - High ROI

2. ✅ **Document policy** (provided: `GENERATED_WGSL_POLICY.md`)
   - Onboards new contributors
   - Records design decisions
   - No runtime cost

### Optional Enhancements (Medium Value, Low Effort)

3. **Pre-commit hook** (template provided in policy doc)
   - Catches issues earlier
   - Adds ~3-5s per commit
   - Developer choice (not enforced)

4. **Build.rs dry-run mode** (future enhancement)
   - `cargo build --features check-codegen` to validate without writing
   - Useful for debugging codegen logic
   - Moderate implementation effort

### Not Recommended

❌ **Runtime generation fallback**: Would violate the policy and introduce non-determinism

❌ **Separate codegen binary**: Adds complexity, no clear benefit over build.rs

❌ **Git hooks enforcement**: Let developers opt-in, enforce in CI only

## Conclusion

**The "commit generated WGSL" policy is correctly implemented and working as designed.**

### Current State
- ✅ Generated files are committed
- ✅ No runtime generation exists
- ✅ Deterministic generation
- ✅ Build-time validation
- ⚠️ No CI enforcement (recommended addition)

### Deliverables Provided
1. **Verification script**: `scripts/check_generated_wgsl.sh`
2. **Policy documentation**: `GENERATED_WGSL_POLICY.md`
3. **Findings report**: This document

### Next Steps
1. **Add CI check**: Integrate `check_generated_wgsl.sh` into your CI pipeline
2. **Review policy doc**: Ensure it matches your team's workflow
3. **Optional**: Add pre-commit hook for individual developers

The minimal guardrails (CI check + documentation) are sufficient to prevent accidental drift while maintaining the existing clean architecture.
