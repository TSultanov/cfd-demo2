pub fn generate_rhie_chow_correct_velocity_wgsl(
    state_stride: u32,
    u_x_offset: u32,
    u_y_offset: u32,
    d_p_offset: u32,
    grad_p_x_offset: u32,
    grad_p_y_offset: u32,
) -> String {
    let mut out = String::new();
    out.push_str("// GENERATED BY CFD2 CODEGEN (rhie_chow_correct_velocity)\n\n");
    out.push_str("// DO NOT EDIT MANUALLY\n\n");

    out.push_str(&format!(
        "const STATE_STRIDE: u32 = {state_stride}u;\n\
const U_X_OFFSET: u32 = {u_x_offset}u;\n\
const U_Y_OFFSET: u32 = {u_y_offset}u;\n\
const D_P_OFFSET: u32 = {d_p_offset}u;\n\
const GRAD_P_X_OFFSET: u32 = {grad_p_x_offset}u;\n\
const GRAD_P_Y_OFFSET: u32 = {grad_p_y_offset}u;\n\n"
    ));

    out.push_str(
        "@group(0) @binding(0)\n\
var<storage, read_write> state: array<f32>;\n\n",
    );

    out.push_str(
        "@compute\n\
@workgroup_size(64)\n\
fn main(@builtin(global_invocation_id) global_id: vec3<u32>) {\n\
    let idx = global_id.x;\n\
    let num_cells = arrayLength(&state) / max(STATE_STRIDE, 1u);\n\
    if (idx >= num_cells) {\n\
        return;\n\
    }\n\
\n\
    let base = idx * STATE_STRIDE;\n\
    let d_p = state[base + D_P_OFFSET];\n\
    let grad_px = state[base + GRAD_P_X_OFFSET];\n\
    let grad_py = state[base + GRAD_P_Y_OFFSET];\n\
\n\
    state[base + U_X_OFFSET] = state[base + U_X_OFFSET] - d_p * grad_px;\n\
    state[base + U_Y_OFFSET] = state[base + U_Y_OFFSET] - d_p * grad_py;\n\
}\n",
    );

    out
}

