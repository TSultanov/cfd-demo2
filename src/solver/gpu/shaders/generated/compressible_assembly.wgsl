// GENERATED BY CFD2 CODEGEN (compressible_assembly)

// DO NOT EDIT MANUALLY

struct Vector2 {
    x: f32,
    y: f32,
}

struct Constants {
    dt: f32,
    dt_old: f32,
    time: f32,
    viscosity: f32,
    density: f32,
    component: u32,
    alpha_p: f32,
    scheme: u32,
    alpha_u: f32,
    stride_x: u32,
    time_scheme: u32,
    inlet_velocity: f32,
    ramp_time: f32,
    precond_type: u32,
}

// Group 0: Mesh

@group(0) @binding(0) 
var<storage, read> face_owner: array<u32>;

@group(0) @binding(1) 
var<storage, read> face_neighbor: array<i32>;

@group(0) @binding(2) 
var<storage, read> face_areas: array<f32>;

@group(0) @binding(3) 
var<storage, read> face_normals: array<Vector2>;

@group(0) @binding(4) 
var<storage, read> cell_centers: array<Vector2>;

@group(0) @binding(5) 
var<storage, read> cell_vols: array<f32>;

@group(0) @binding(6) 
var<storage, read> cell_face_offsets: array<u32>;

@group(0) @binding(7) 
var<storage, read> cell_faces: array<u32>;

@group(0) @binding(8) 
var<storage, read> cell_face_matrix_indices: array<u32>;

@group(0) @binding(9) 
var<storage, read> diagonal_indices: array<u32>;

@group(0) @binding(12) 
var<storage, read> face_boundary: array<u32>;

@group(0) @binding(13) 
var<storage, read> face_centers: array<Vector2>;

// Group 1: Fields (consolidated state buffers)

@group(1) @binding(0) 
var<storage, read_write> state: array<f32>;

@group(1) @binding(1) 
var<storage, read> state_old: array<f32>;

@group(1) @binding(2) 
var<storage, read> state_old_old: array<f32>;

@group(1) @binding(3) 
var<storage, read_write> fluxes: array<f32>;

@group(1) @binding(4) 
var<uniform> constants: Constants;

@group(1) @binding(5) 
var<storage, read_write> grad_rho: array<Vector2>;

@group(1) @binding(6) 
var<storage, read_write> grad_rho_u_x: array<Vector2>;

@group(1) @binding(7) 
var<storage, read_write> grad_rho_u_y: array<Vector2>;

@group(1) @binding(8) 
var<storage, read_write> grad_rho_e: array<Vector2>;

// Group 2: Solver

@group(2) @binding(0) 
var<storage, read_write> matrix_values: array<f32>;

@group(2) @binding(1) 
var<storage, read_write> rhs: array<f32>;

@group(2) @binding(2) 
var<storage, read> scalar_row_offsets: array<u32>;

@compute
@workgroup_size(64)
fn main(@builtin(global_invocation_id) global_id: vec3<u32>) {
    let idx = global_id.x;
    if (idx >= arrayLength(&cell_vols)) {
        return;
    }
    let center = cell_centers[idx];
    let start = cell_face_offsets[idx];
    let end = cell_face_offsets[idx + 1u];
    let vol = cell_vols[idx];
    let scalar_offset = scalar_row_offsets[idx];
    let num_neighbors = scalar_row_offsets[idx + 1u] - scalar_offset;
    let start_row_0 = 16u * scalar_offset;
    let start_row_1 = start_row_0 + 4u * num_neighbors;
    let start_row_2 = start_row_0 + 8u * num_neighbors;
    let start_row_3 = start_row_0 + 12u * num_neighbors;
    let scheme_id = constants.scheme;
    // Jacobian rows/cols: rho, rho_u_x, rho_u_y, rho_e
    var diag_00 = 0.0;
    var diag_01 = 0.0;
    var diag_02 = 0.0;
    var diag_03 = 0.0;
    var diag_10 = 0.0;
    var diag_11 = 0.0;
    var diag_12 = 0.0;
    var diag_13 = 0.0;
    var diag_20 = 0.0;
    var diag_21 = 0.0;
    var diag_22 = 0.0;
    var diag_23 = 0.0;
    var diag_30 = 0.0;
    var diag_31 = 0.0;
    var diag_32 = 0.0;
    var diag_33 = 0.0;
    var sum_rho = 0.0;
    var sum_rho_u_x = 0.0;
    var sum_rho_u_y = 0.0;
    var sum_rho_e = 0.0;
    let rho = state[idx * 7u + 0u];
    let rho_u = vec2<f32>(state[idx * 7u + 1u], state[idx * 7u + 2u]);
    let rho_e = state[idx * 7u + 3u];
    let rho_old = state_old[idx * 7u + 0u];
    let rho_u_old = vec2<f32>(state_old[idx * 7u + 1u], state_old[idx * 7u + 2u]);
    let rho_e_old = state_old[idx * 7u + 3u];
    var coeff_time = vol / constants.dt;
    var rhs_time_rho = coeff_time * rho_old;
    var rhs_time_rho_u_x = coeff_time * rho_u_old.x;
    var rhs_time_rho_u_y = coeff_time * rho_u_old.y;
    var rhs_time_rho_e = coeff_time * rho_e_old;
    if (constants.time_scheme == 1u) {
        let dt = constants.dt;
        let dt_old = constants.dt_old;
        let r = dt / dt_old;
        let rho_old_old = state_old_old[idx * 7u + 0u];
        let rho_u_old_old = vec2<f32>(state_old_old[idx * 7u + 1u], state_old_old[idx * 7u + 2u]);
        let rho_e_old_old = state_old_old[idx * 7u + 3u];
        coeff_time = vol / dt * (1.0 + 2.0 * r) / (1.0 + r);
        let factor_n = 1.0 + r;
        let factor_nm1 = r * r / (1.0 + r);
        rhs_time_rho = vol / dt * (factor_n * rho_old - factor_nm1 * rho_old_old);
        rhs_time_rho_u_x = vol / dt * (factor_n * rho_u_old.x - factor_nm1 * rho_u_old_old.x);
        rhs_time_rho_u_y = vol / dt * (factor_n * rho_u_old.y - factor_nm1 * rho_u_old_old.y);
        rhs_time_rho_e = vol / dt * (factor_n * rho_e_old - factor_nm1 * rho_e_old_old);
    }
    for (var face_offset = start; face_offset < end; face_offset++) {
        let face_idx = cell_faces[face_offset];
        let owner = face_owner[face_idx];
        let neighbor = face_neighbor[face_idx];
        let boundary_type = face_boundary[face_idx];
        let area = face_areas[face_idx];
        var normal = face_normals[face_idx];
        let f_center = face_centers[face_idx];
        var is_boundary = false;
        var other_idx = 0u;
        var center_r: Vector2;
        if (owner != idx) {
            normal.x = -normal.x;
            normal.y = -normal.y;
        }
        let rho_l = state[idx * 7u + 0u];
        let rho_u_l = vec2<f32>(state[idx * 7u + 1u], state[idx * 7u + 2u]);
        let rho_e_l = state[idx * 7u + 3u];
        var rho_r = rho_l;
        var rho_u_r = rho_u_l;
        var rho_e_r = rho_e_l;
        if (neighbor != -1) {
            let neigh_idx = u32(neighbor);
            other_idx = neigh_idx;
            if (owner != idx) {
                other_idx = owner;
            }
            center_r = cell_centers[other_idx];
            let rho_neigh = state[other_idx * 7u + 0u];
            let rho_u_neigh = vec2<f32>(state[other_idx * 7u + 1u], state[other_idx * 7u + 2u]);
            let rho_e_neigh = state[other_idx * 7u + 3u];
            rho_r = rho_neigh;
            rho_u_r.x = rho_u_neigh.x;
            rho_u_r.y = rho_u_neigh.y;
            rho_e_r = rho_e_neigh;
        } else {
            is_boundary = true;
            other_idx = idx;
            center_r = f_center;
        }
        if (is_boundary) {
            if (boundary_type == 1u) {
                rho_u_r.x = rho_r * constants.inlet_velocity;
                rho_u_r.y = 0.0;
            } else {
                if (boundary_type == 3u) {
                    rho_u_r.x = -rho_u_l.x;
                    rho_u_r.y = -rho_u_l.y;
                }
            }
        }
        let inv_rho_l = 1.0 / max(rho_l, 1e-8);
        let u_l_x = rho_u_l.x * inv_rho_l;
        let u_l_y = rho_u_l.y * inv_rho_l;
        let ke_l = 0.5 * rho_l * (u_l_x * u_l_x + u_l_y * u_l_y);
        let p_l = max(0.0, (1.4 - 1.0) * (rho_e_l - ke_l));
        let u_n_l = u_l_x * normal.x + u_l_y * normal.y;
        let c_l = sqrt(1.4 * p_l * inv_rho_l);
        let inv_rho_r = 1.0 / max(rho_r, 1e-8);
        let u_r_x = rho_u_r.x * inv_rho_r;
        let u_r_y = rho_u_r.y * inv_rho_r;
        let ke_r = 0.5 * rho_r * (u_r_x * u_r_x + u_r_y * u_r_y);
        let p_r = max(0.0, (1.4 - 1.0) * (rho_e_r - ke_r));
        let u_n_r = u_r_x * normal.x + u_r_y * normal.y;
        let c_r = sqrt(1.4 * p_r * inv_rho_r);
        let u_face_x = 0.5 * (u_l_x + u_r_x);
        let u_face_y = 0.5 * (u_l_y + u_r_y);
        let u_face_n = u_face_x * normal.x + u_face_y * normal.y;
        let c_bar = 0.5 * (c_l + c_r);
        let mach = abs(u_face_n) / max(c_bar, 1e-6);
        let beta = max(mach, 0.01);
        let c_l_eff = c_l * beta;
        let c_r_eff = c_r * beta;
        let flux_adv = u_face_n * area;
        let dx = center_r.x - center.x;
        let dy = center_r.y - center.y;
        let dist = max(sqrt(dx * dx + dy * dy), 1e-6);
        let mu = constants.viscosity;
        let a_plus = max(0.0, max(u_n_l + c_l_eff, u_n_r + c_r_eff));
        let a_minus = min(0.0, min(u_n_l - c_l_eff, u_n_r - c_r_eff));
        let denom = max(a_plus - a_minus, 1e-6);
        let a_prod = a_plus * a_minus;
        let f_rho_l = rho_l * u_n_l;
        let f_rho_r = rho_r * u_n_r;
        let flux_rho = (a_plus * f_rho_l - a_minus * f_rho_r + a_prod * (rho_r - rho_l)) / denom;
        let f_rho_u_l_x = rho_u_l.x * u_n_l + p_l * normal.x;
        let f_rho_u_l_y = rho_u_l.y * u_n_l + p_l * normal.y;
        let f_rho_u_r_x = rho_u_r.x * u_n_r + p_r * normal.x;
        let f_rho_u_r_y = rho_u_r.y * u_n_r + p_r * normal.y;
        var flux_rho_u_x = (a_plus * f_rho_u_l_x - a_minus * f_rho_u_r_x + a_prod * (rho_u_r.x - rho_u_l.x)) / denom;
        var flux_rho_u_y = (a_plus * f_rho_u_l_y - a_minus * f_rho_u_r_y + a_prod * (rho_u_r.y - rho_u_l.y)) / denom;
        let diff_u_x = -mu * (u_r_x - u_l_x) / dist;
        let diff_u_y = -mu * (u_r_y - u_l_y) / dist;
        flux_rho_u_x = flux_rho_u_x + diff_u_x;
        flux_rho_u_y = flux_rho_u_y + diff_u_y;
        let f_rho_e_l = (rho_e_l + p_l) * u_n_l;
        let f_rho_e_r = (rho_e_r + p_r) * u_n_r;
        var flux_rho_e = (a_plus * f_rho_e_l - a_minus * f_rho_e_r + a_prod * (rho_e_r - rho_e_l)) / denom;
        flux_rho_e = flux_rho_e + diff_u_x * u_face_x + diff_u_y * u_face_y;
        sum_rho += flux_rho * area;
        sum_rho_u_x += flux_rho_u_x * area;
        sum_rho_u_y += flux_rho_u_y * area;
        sum_rho_e += flux_rho_e * area;
        let q_l = u_l_x * u_l_x + u_l_y * u_l_y;
        let dp_drho_l = 0.5 * (1.4 - 1.0) * q_l;
        let dp_dru_l = -(1.4 - 1.0) * u_l_x;
        let dp_drv_l = -(1.4 - 1.0) * u_l_y;
        let dp_dre_l = 1.4 - 1.0;
        let H_l = (rho_e_l + p_l) * inv_rho_l;
        let q_r = u_r_x * u_r_x + u_r_y * u_r_y;
        let dp_drho_r = 0.5 * (1.4 - 1.0) * q_r;
        let dp_dru_r = -(1.4 - 1.0) * u_r_x;
        let dp_drv_r = -(1.4 - 1.0) * u_r_y;
        let dp_dre_r = 1.4 - 1.0;
        let H_r = (rho_e_r + p_r) * inv_rho_r;
        let a_l = a_plus / denom;
        let a_r = -a_minus / denom;
        let a_prod_scaled = a_prod / denom;
        var jac_l_00 = -a_prod_scaled;
        var jac_l_01 = a_l * normal.x;
        var jac_l_02 = a_l * normal.y;
        var jac_l_03 = 0.0;
        var jac_r_00 = a_prod_scaled;
        var jac_r_01 = a_r * normal.x;
        var jac_r_02 = a_r * normal.y;
        var jac_r_03 = 0.0;
        let A_l_10 = -u_l_x * u_n_l + dp_drho_l * normal.x;
        let A_l_11 = u_n_l + u_l_x * normal.x + dp_dru_l * normal.x;
        let A_l_12 = u_l_x * normal.y + dp_drv_l * normal.x;
        let A_l_13 = dp_dre_l * normal.x;
        let A_l_20 = -u_l_y * u_n_l + dp_drho_l * normal.y;
        let A_l_21 = u_l_y * normal.x + dp_dru_l * normal.y;
        let A_l_22 = u_n_l + u_l_y * normal.y + dp_drv_l * normal.y;
        let A_l_23 = dp_dre_l * normal.y;
        let A_l_30 = -H_l * u_n_l + dp_drho_l * u_n_l;
        let A_l_31 = H_l * normal.x + dp_dru_l * u_n_l;
        let A_l_32 = H_l * normal.y + dp_drv_l * u_n_l;
        let A_l_33 = 1.4 * u_n_l;
        let A_r_10 = -u_r_x * u_n_r + dp_drho_r * normal.x;
        let A_r_11 = u_n_r + u_r_x * normal.x + dp_dru_r * normal.x;
        let A_r_12 = u_r_x * normal.y + dp_drv_r * normal.x;
        let A_r_13 = dp_dre_r * normal.x;
        let A_r_20 = -u_r_y * u_n_r + dp_drho_r * normal.y;
        let A_r_21 = u_r_y * normal.x + dp_dru_r * normal.y;
        let A_r_22 = u_n_r + u_r_y * normal.y + dp_drv_r * normal.y;
        let A_r_23 = dp_dre_r * normal.y;
        let A_r_30 = -H_r * u_n_r + dp_drho_r * u_n_r;
        let A_r_31 = H_r * normal.x + dp_dru_r * u_n_r;
        let A_r_32 = H_r * normal.y + dp_drv_r * u_n_r;
        let A_r_33 = 1.4 * u_n_r;
        var jac_l_10 = a_l * A_l_10;
        var jac_l_11 = a_l * A_l_11 - a_prod_scaled;
        var jac_l_12 = a_l * A_l_12;
        var jac_l_13 = a_l * A_l_13;
        var jac_r_10 = a_r * A_r_10;
        var jac_r_11 = a_r * A_r_11 + a_prod_scaled;
        var jac_r_12 = a_r * A_r_12;
        var jac_r_13 = a_r * A_r_13;
        var jac_l_20 = a_l * A_l_20;
        var jac_l_21 = a_l * A_l_21;
        var jac_l_22 = a_l * A_l_22 - a_prod_scaled;
        var jac_l_23 = a_l * A_l_23;
        var jac_r_20 = a_r * A_r_20;
        var jac_r_21 = a_r * A_r_21;
        var jac_r_22 = a_r * A_r_22 + a_prod_scaled;
        var jac_r_23 = a_r * A_r_23;
        var jac_l_30 = a_l * A_l_30;
        var jac_l_31 = a_l * A_l_31;
        var jac_l_32 = a_l * A_l_32;
        var jac_l_33 = a_l * A_l_33 - a_prod_scaled;
        var jac_r_30 = a_r * A_r_30;
        var jac_r_31 = a_r * A_r_31;
        var jac_r_32 = a_r * A_r_32;
        var jac_r_33 = a_r * A_r_33 + a_prod_scaled;
        let mu_over_dist = mu / dist;
        let du_lx_drho = -u_l_x * inv_rho_l;
        let du_lx_dru = inv_rho_l;
        let du_lx_drv = 0.0;
        let du_ly_drho = -u_l_y * inv_rho_l;
        let du_ly_dru = 0.0;
        let du_ly_drv = inv_rho_l;
        let du_rx_drho = -u_r_x * inv_rho_r;
        let du_rx_dru = inv_rho_r;
        let du_rx_drv = 0.0;
        let du_ry_drho = -u_r_y * inv_rho_r;
        let du_ry_dru = 0.0;
        let du_ry_drv = inv_rho_r;
        let d_diff_x_l_rho = mu_over_dist * du_lx_drho;
        let d_diff_x_l_ru = mu_over_dist * du_lx_dru;
        let d_diff_x_l_rv = 0.0;
        let d_diff_x_l_re = 0.0;
        let d_diff_y_l_rho = mu_over_dist * du_ly_drho;
        let d_diff_y_l_ru = 0.0;
        let d_diff_y_l_rv = mu_over_dist * du_ly_drv;
        let d_diff_y_l_re = 0.0;
        let d_diff_x_r_rho = -mu_over_dist * du_rx_drho;
        let d_diff_x_r_ru = -mu_over_dist * du_rx_dru;
        let d_diff_x_r_rv = 0.0;
        let d_diff_x_r_re = 0.0;
        let d_diff_y_r_rho = -mu_over_dist * du_ry_drho;
        let d_diff_y_r_ru = 0.0;
        let d_diff_y_r_rv = -mu_over_dist * du_ry_drv;
        let d_diff_y_r_re = 0.0;
        jac_l_10 += d_diff_x_l_rho;
        jac_l_11 += d_diff_x_l_ru;
        jac_l_12 += d_diff_x_l_rv;
        jac_l_13 += d_diff_x_l_re;
        jac_l_20 += d_diff_y_l_rho;
        jac_l_21 += d_diff_y_l_ru;
        jac_l_22 += d_diff_y_l_rv;
        jac_l_23 += d_diff_y_l_re;
        jac_r_10 += d_diff_x_r_rho;
        jac_r_11 += d_diff_x_r_ru;
        jac_r_12 += d_diff_x_r_rv;
        jac_r_13 += d_diff_x_r_re;
        jac_r_20 += d_diff_y_r_rho;
        jac_r_21 += d_diff_y_r_ru;
        jac_r_22 += d_diff_y_r_rv;
        jac_r_23 += d_diff_y_r_re;
        let du_face_x_l_rho = 0.5 * du_lx_drho;
        let du_face_x_l_ru = 0.5 * du_lx_dru;
        let du_face_x_l_rv = 0.0;
        let du_face_x_l_re = 0.0;
        let du_face_y_l_rho = 0.5 * du_ly_drho;
        let du_face_y_l_ru = 0.0;
        let du_face_y_l_rv = 0.5 * du_ly_drv;
        let du_face_y_l_re = 0.0;
        let du_face_x_r_rho = 0.5 * du_rx_drho;
        let du_face_x_r_ru = 0.5 * du_rx_dru;
        let du_face_x_r_rv = 0.0;
        let du_face_x_r_re = 0.0;
        let du_face_y_r_rho = 0.5 * du_ry_drho;
        let du_face_y_r_ru = 0.0;
        let du_face_y_r_rv = 0.5 * du_ry_drv;
        let du_face_y_r_re = 0.0;
        let d_e_visc_l_rho = d_diff_x_l_rho * u_face_x + diff_u_x * du_face_x_l_rho + d_diff_y_l_rho * u_face_y + diff_u_y * du_face_y_l_rho;
        let d_e_visc_l_ru = d_diff_x_l_ru * u_face_x + diff_u_x * du_face_x_l_ru + d_diff_y_l_ru * u_face_y + diff_u_y * du_face_y_l_ru;
        let d_e_visc_l_rv = d_diff_x_l_rv * u_face_x + diff_u_x * du_face_x_l_rv + d_diff_y_l_rv * u_face_y + diff_u_y * du_face_y_l_rv;
        let d_e_visc_l_re = d_diff_x_l_re * u_face_x + diff_u_x * du_face_x_l_re + d_diff_y_l_re * u_face_y + diff_u_y * du_face_y_l_re;
        let d_e_visc_r_rho = d_diff_x_r_rho * u_face_x + diff_u_x * du_face_x_r_rho + d_diff_y_r_rho * u_face_y + diff_u_y * du_face_y_r_rho;
        let d_e_visc_r_ru = d_diff_x_r_ru * u_face_x + diff_u_x * du_face_x_r_ru + d_diff_y_r_ru * u_face_y + diff_u_y * du_face_y_r_ru;
        let d_e_visc_r_rv = d_diff_x_r_rv * u_face_x + diff_u_x * du_face_x_r_rv + d_diff_y_r_rv * u_face_y + diff_u_y * du_face_y_r_rv;
        let d_e_visc_r_re = d_diff_x_r_re * u_face_x + diff_u_x * du_face_x_r_re + d_diff_y_r_re * u_face_y + diff_u_y * du_face_y_r_re;
        jac_l_30 += d_e_visc_l_rho;
        jac_l_31 += d_e_visc_l_ru;
        jac_l_32 += d_e_visc_l_rv;
        jac_l_33 += d_e_visc_l_re;
        jac_r_30 += d_e_visc_r_rho;
        jac_r_31 += d_e_visc_r_ru;
        jac_r_32 += d_e_visc_r_rv;
        jac_r_33 += d_e_visc_r_re;
        if (!is_boundary) {
            let scalar_mat_idx = cell_face_matrix_indices[face_offset];
            var neighbor_rank = 0u;
            if (scalar_mat_idx != 4294967295u) {
                neighbor_rank = scalar_mat_idx - scalar_offset;
            } else {
                neighbor_rank = scalar_mat_idx - scalar_offset;
            }
            let base_0 = start_row_0 + 4u * neighbor_rank;
            let base_1 = start_row_1 + 4u * neighbor_rank;
            let base_2 = start_row_2 + 4u * neighbor_rank;
            let base_3 = start_row_3 + 4u * neighbor_rank;
            if (scheme_id != 0u) {
                var phi_upwind_rho = rho_l;
                if (flux_adv < 0.0) {
                    phi_upwind_rho = rho_r;
                }
                var phi_ho_rho = phi_upwind_rho;
                if (scheme_id == 1u) {
                    if (flux_adv > 0.0) {
                        let r_rho_x = f_center.x - center.x;
                        let r_rho_y = f_center.y - center.y;
                        phi_ho_rho = rho_l + grad_rho[idx].x * r_rho_x + grad_rho[idx].y * r_rho_y;
                    } else {
                        let r_rho_x = f_center.x - center_r.x;
                        let r_rho_y = f_center.y - center_r.y;
                        phi_ho_rho = rho_r + grad_rho[other_idx].x * r_rho_x + grad_rho[other_idx].y * r_rho_y;
                    }
                } else {
                    if (scheme_id == 2u) {
                        if (flux_adv > 0.0) {
                            let d_cd_rho_x = center_r.x - center.x;
                            let d_cd_rho_y = center_r.y - center.y;
                            let grad_term_rho = grad_rho[idx].x * d_cd_rho_x + grad_rho[idx].y * d_cd_rho_y;
                            phi_ho_rho = 0.625 * rho_l + 0.375 * rho_r + 0.125 * grad_term_rho;
                        } else {
                            let d_cd_rho_x = center.x - center_r.x;
                            let d_cd_rho_y = center.y - center_r.y;
                            let grad_term_rho = grad_rho[other_idx].x * d_cd_rho_x + grad_rho[other_idx].y * d_cd_rho_y;
                            phi_ho_rho = 0.625 * rho_r + 0.375 * rho_l + 0.125 * grad_term_rho;
                        }
                    }
                }
                var phi_upwind_ru = rho_u_l.x;
                if (flux_adv < 0.0) {
                    phi_upwind_ru = rho_u_r.x;
                }
                var phi_ho_ru = phi_upwind_ru;
                if (scheme_id == 1u) {
                    if (flux_adv > 0.0) {
                        let r_ru_x = f_center.x - center.x;
                        let r_ru_y = f_center.y - center.y;
                        phi_ho_ru = rho_u_l.x + grad_rho_u_x[idx].x * r_ru_x + grad_rho_u_x[idx].y * r_ru_y;
                    } else {
                        let r_ru_x = f_center.x - center_r.x;
                        let r_ru_y = f_center.y - center_r.y;
                        phi_ho_ru = rho_u_r.x + grad_rho_u_x[other_idx].x * r_ru_x + grad_rho_u_x[other_idx].y * r_ru_y;
                    }
                } else {
                    if (scheme_id == 2u) {
                        if (flux_adv > 0.0) {
                            let d_cd_ru_x = center_r.x - center.x;
                            let d_cd_ru_y = center_r.y - center.y;
                            let grad_term_ru = grad_rho_u_x[idx].x * d_cd_ru_x + grad_rho_u_x[idx].y * d_cd_ru_y;
                            phi_ho_ru = 0.625 * rho_u_l.x + 0.375 * rho_u_r.x + 0.125 * grad_term_ru;
                        } else {
                            let d_cd_ru_x = center.x - center_r.x;
                            let d_cd_ru_y = center.y - center_r.y;
                            let grad_term_ru = grad_rho_u_x[other_idx].x * d_cd_ru_x + grad_rho_u_x[other_idx].y * d_cd_ru_y;
                            phi_ho_ru = 0.625 * rho_u_r.x + 0.375 * rho_u_l.x + 0.125 * grad_term_ru;
                        }
                    }
                }
                var phi_upwind_rv = rho_u_l.y;
                if (flux_adv < 0.0) {
                    phi_upwind_rv = rho_u_r.y;
                }
                var phi_ho_rv = phi_upwind_rv;
                if (scheme_id == 1u) {
                    if (flux_adv > 0.0) {
                        let r_rv_x = f_center.x - center.x;
                        let r_rv_y = f_center.y - center.y;
                        phi_ho_rv = rho_u_l.y + grad_rho_u_y[idx].x * r_rv_x + grad_rho_u_y[idx].y * r_rv_y;
                    } else {
                        let r_rv_x = f_center.x - center_r.x;
                        let r_rv_y = f_center.y - center_r.y;
                        phi_ho_rv = rho_u_r.y + grad_rho_u_y[other_idx].x * r_rv_x + grad_rho_u_y[other_idx].y * r_rv_y;
                    }
                } else {
                    if (scheme_id == 2u) {
                        if (flux_adv > 0.0) {
                            let d_cd_rv_x = center_r.x - center.x;
                            let d_cd_rv_y = center_r.y - center.y;
                            let grad_term_rv = grad_rho_u_y[idx].x * d_cd_rv_x + grad_rho_u_y[idx].y * d_cd_rv_y;
                            phi_ho_rv = 0.625 * rho_u_l.y + 0.375 * rho_u_r.y + 0.125 * grad_term_rv;
                        } else {
                            let d_cd_rv_x = center.x - center_r.x;
                            let d_cd_rv_y = center.y - center_r.y;
                            let grad_term_rv = grad_rho_u_y[other_idx].x * d_cd_rv_x + grad_rho_u_y[other_idx].y * d_cd_rv_y;
                            phi_ho_rv = 0.625 * rho_u_r.y + 0.375 * rho_u_l.y + 0.125 * grad_term_rv;
                        }
                    }
                }
                var phi_upwind_re = rho_e_l;
                if (flux_adv < 0.0) {
                    phi_upwind_re = rho_e_r;
                }
                var phi_ho_re = phi_upwind_re;
                if (scheme_id == 1u) {
                    if (flux_adv > 0.0) {
                        let r_re_x = f_center.x - center.x;
                        let r_re_y = f_center.y - center.y;
                        phi_ho_re = rho_e_l + grad_rho_e[idx].x * r_re_x + grad_rho_e[idx].y * r_re_y;
                    } else {
                        let r_re_x = f_center.x - center_r.x;
                        let r_re_y = f_center.y - center_r.y;
                        phi_ho_re = rho_e_r + grad_rho_e[other_idx].x * r_re_x + grad_rho_e[other_idx].y * r_re_y;
                    }
                } else {
                    if (scheme_id == 2u) {
                        if (flux_adv > 0.0) {
                            let d_cd_re_x = center_r.x - center.x;
                            let d_cd_re_y = center_r.y - center.y;
                            let grad_term_re = grad_rho_e[idx].x * d_cd_re_x + grad_rho_e[idx].y * d_cd_re_y;
                            phi_ho_re = 0.625 * rho_e_l + 0.375 * rho_e_r + 0.125 * grad_term_re;
                        } else {
                            let d_cd_re_x = center.x - center_r.x;
                            let d_cd_re_y = center.y - center_r.y;
                            let grad_term_re = grad_rho_e[other_idx].x * d_cd_re_x + grad_rho_e[other_idx].y * d_cd_re_y;
                            phi_ho_re = 0.625 * rho_e_r + 0.375 * rho_e_l + 0.125 * grad_term_re;
                        }
                    }
                }
                let correction_rho = flux_adv * (phi_ho_rho - phi_upwind_rho);
                let correction_rho_u_x = flux_adv * (phi_ho_ru - phi_upwind_ru);
                let correction_rho_u_y = flux_adv * (phi_ho_rv - phi_upwind_rv);
                let correction_rho_e = flux_adv * (phi_ho_re - phi_upwind_re);
                sum_rho += correction_rho;
                sum_rho_u_x += correction_rho_u_x;
                sum_rho_u_y += correction_rho_u_y;
                sum_rho_e += correction_rho_e;
            }
            matrix_values[base_0 + 0u] = jac_r_00 * area;
            matrix_values[base_0 + 1u] = jac_r_01 * area;
            matrix_values[base_0 + 2u] = jac_r_02 * area;
            matrix_values[base_0 + 3u] = jac_r_03 * area;
            matrix_values[base_1 + 0u] = jac_r_10 * area;
            matrix_values[base_1 + 1u] = jac_r_11 * area;
            matrix_values[base_1 + 2u] = jac_r_12 * area;
            matrix_values[base_1 + 3u] = jac_r_13 * area;
            matrix_values[base_2 + 0u] = jac_r_20 * area;
            matrix_values[base_2 + 1u] = jac_r_21 * area;
            matrix_values[base_2 + 2u] = jac_r_22 * area;
            matrix_values[base_2 + 3u] = jac_r_23 * area;
            matrix_values[base_3 + 0u] = jac_r_30 * area;
            matrix_values[base_3 + 1u] = jac_r_31 * area;
            matrix_values[base_3 + 2u] = jac_r_32 * area;
            matrix_values[base_3 + 3u] = jac_r_33 * area;
            diag_00 += jac_l_00 * area;
            diag_01 += jac_l_01 * area;
            diag_02 += jac_l_02 * area;
            diag_03 += jac_l_03 * area;
            diag_10 += jac_l_10 * area;
            diag_11 += jac_l_11 * area;
            diag_12 += jac_l_12 * area;
            diag_13 += jac_l_13 * area;
            diag_20 += jac_l_20 * area;
            diag_21 += jac_l_21 * area;
            diag_22 += jac_l_22 * area;
            diag_23 += jac_l_23 * area;
            diag_30 += jac_l_30 * area;
            diag_31 += jac_l_31 * area;
            diag_32 += jac_l_32 * area;
            diag_33 += jac_l_33 * area;
        } else {
            var eff_00 = jac_l_00 + jac_r_00;
            var eff_01 = jac_l_01 + jac_r_01;
            var eff_02 = jac_l_02 + jac_r_02;
            var eff_03 = jac_l_03 + jac_r_03;
            var eff_10 = jac_l_10 + jac_r_10;
            var eff_11 = jac_l_11 + jac_r_11;
            var eff_12 = jac_l_12 + jac_r_12;
            var eff_13 = jac_l_13 + jac_r_13;
            var eff_20 = jac_l_20 + jac_r_20;
            var eff_21 = jac_l_21 + jac_r_21;
            var eff_22 = jac_l_22 + jac_r_22;
            var eff_23 = jac_l_23 + jac_r_23;
            var eff_30 = jac_l_30 + jac_r_30;
            var eff_31 = jac_l_31 + jac_r_31;
            var eff_32 = jac_l_32 + jac_r_32;
            var eff_33 = jac_l_33 + jac_r_33;
            if (boundary_type == 1u) {
                eff_00 = jac_l_00 + jac_r_00 + jac_r_01 * constants.inlet_velocity;
                eff_01 = jac_l_01;
                eff_02 = jac_l_02;
                eff_03 = jac_l_03 + jac_r_03;
                eff_10 = jac_l_10 + jac_r_10 + jac_r_11 * constants.inlet_velocity;
                eff_11 = jac_l_11;
                eff_12 = jac_l_12;
                eff_13 = jac_l_13 + jac_r_13;
                eff_20 = jac_l_20 + jac_r_20 + jac_r_21 * constants.inlet_velocity;
                eff_21 = jac_l_21;
                eff_22 = jac_l_22;
                eff_23 = jac_l_23 + jac_r_23;
                eff_30 = jac_l_30 + jac_r_30 + jac_r_31 * constants.inlet_velocity;
                eff_31 = jac_l_31;
                eff_32 = jac_l_32;
                eff_33 = jac_l_33 + jac_r_33;
            } else {
                if (boundary_type == 3u) {
                    eff_00 = jac_l_00 + jac_r_00;
                    eff_01 = jac_l_01 - jac_r_01;
                    eff_02 = jac_l_02 - jac_r_02;
                    eff_03 = jac_l_03 + jac_r_03;
                    eff_10 = jac_l_10 + jac_r_10;
                    eff_11 = jac_l_11 - jac_r_11;
                    eff_12 = jac_l_12 - jac_r_12;
                    eff_13 = jac_l_13 + jac_r_13;
                    eff_20 = jac_l_20 + jac_r_20;
                    eff_21 = jac_l_21 - jac_r_21;
                    eff_22 = jac_l_22 - jac_r_22;
                    eff_23 = jac_l_23 + jac_r_23;
                    eff_30 = jac_l_30 + jac_r_30;
                    eff_31 = jac_l_31 - jac_r_31;
                    eff_32 = jac_l_32 - jac_r_32;
                    eff_33 = jac_l_33 + jac_r_33;
                }
            }
            diag_00 += eff_00 * area;
            diag_01 += eff_01 * area;
            diag_02 += eff_02 * area;
            diag_03 += eff_03 * area;
            diag_10 += eff_10 * area;
            diag_11 += eff_11 * area;
            diag_12 += eff_12 * area;
            diag_13 += eff_13 * area;
            diag_20 += eff_20 * area;
            diag_21 += eff_21 * area;
            diag_22 += eff_22 * area;
            diag_23 += eff_23 * area;
            diag_30 += eff_30 * area;
            diag_31 += eff_31 * area;
            diag_32 += eff_32 * area;
            diag_33 += eff_33 * area;
        }
    }
    var rhs_rho = rhs_time_rho - coeff_time * rho - sum_rho;
    var rhs_rho_u_x = rhs_time_rho_u_x - coeff_time * rho_u.x - sum_rho_u_x;
    var rhs_rho_u_y = rhs_time_rho_u_y - coeff_time * rho_u.y - sum_rho_u_y;
    var rhs_rho_e = rhs_time_rho_e - coeff_time * rho_e - sum_rho_e;
    diag_00 += coeff_time;
    diag_11 += coeff_time;
    diag_22 += coeff_time;
    diag_33 += coeff_time;
    let scalar_diag_idx = diagonal_indices[idx];
    let diag_rank = scalar_diag_idx - scalar_offset;
    let diag_base_0 = start_row_0 + 4u * diag_rank;
    let diag_base_1 = start_row_1 + 4u * diag_rank;
    let diag_base_2 = start_row_2 + 4u * diag_rank;
    let diag_base_3 = start_row_3 + 4u * diag_rank;
    matrix_values[diag_base_0 + 0u] = diag_00;
    matrix_values[diag_base_0 + 1u] = diag_01;
    matrix_values[diag_base_0 + 2u] = diag_02;
    matrix_values[diag_base_0 + 3u] = diag_03;
    matrix_values[diag_base_1 + 0u] = diag_10;
    matrix_values[diag_base_1 + 1u] = diag_11;
    matrix_values[diag_base_1 + 2u] = diag_12;
    matrix_values[diag_base_1 + 3u] = diag_13;
    matrix_values[diag_base_2 + 0u] = diag_20;
    matrix_values[diag_base_2 + 1u] = diag_21;
    matrix_values[diag_base_2 + 2u] = diag_22;
    matrix_values[diag_base_2 + 3u] = diag_23;
    matrix_values[diag_base_3 + 0u] = diag_30;
    matrix_values[diag_base_3 + 1u] = diag_31;
    matrix_values[diag_base_3 + 2u] = diag_32;
    matrix_values[diag_base_3 + 3u] = diag_33;
    rhs[4u * idx + 0u] = rhs_rho;
    rhs[4u * idx + 1u] = rhs_rho_u_x;
    rhs[4u * idx + 2u] = rhs_rho_u_y;
    rhs[4u * idx + 3u] = rhs_rho_e;
}
