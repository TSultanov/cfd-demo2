# Reference solutions (OpenFOAM)

This repo includes regression tests that compare `cfd2` against reference data generated with OpenFOAM v2512.

To run the reference suite (and fail loudly if it accidentally runs 0 tests):

- `bash scripts/run_openfoam_reference_tests.sh`

Note: the OpenFOAM reference tests are marked `#[ignore]` so `cargo test` stays fast; the script
runs them with `-- --ignored`.

## Visual sanity check (required)

In addition to the numerical error metrics, always do a quick *visual* comparison of the
OpenFOAM reference fields vs the `cfd2` fields.

Each OpenFOAM reference test writes plots into:

- `target/test_plots/openfoam/<case>/`

The directory contains `u_x`, `u_y`, `u_mag`, and `p` images for both the reference and solver
output (pressure is plotted mean-free).

If a metric regresses or a reference CSV is regenerated, open the images side-by-side and sanity
check that the field structure matches (not just the norms).

The OpenFOAM case templates live in:

- `reference/openfoam/incompressible_channel`
- `reference/openfoam/incompressible_backwards_step`
- `reference/openfoam/incompressible_lid_driven_cavity`
- `reference/openfoam/compressible_acoustic_box`
- `reference/openfoam/compressible_backwards_step`
- `reference/openfoam/compressible_lid_driven_cavity`
- `reference/openfoam/compressible_supersonic_wedge`

The committed reference datasets live in:

- `tests/openfoam_reference/data/incompressible_channel_centerline.csv`
- `tests/openfoam_reference/data/incompressible_channel_full_field.csv`
- `tests/openfoam_reference/data/compressible_acoustic_centerline.csv`
- `tests/openfoam_reference/data/compressible_acoustic_full_field.csv`
- `tests/openfoam_reference/data/incompressible_backwards_step_full_field.csv`
- `tests/openfoam_reference/data/incompressible_lid_driven_cavity_full_field.csv`
- `tests/openfoam_reference/data/compressible_backwards_step_full_field.csv`
- `tests/openfoam_reference/data/compressible_lid_driven_cavity_full_field.csv`
- `tests/openfoam_reference/data/compressible_supersonic_wedge_full_field.csv`

## Regenerating reference data

1. Ensure OpenFOAM v2512 is available (this machine provides the `openfoam` wrapper and `/Volumes/OpenFOAM-v2512`).
2. Run:
   - `bash scripts/regenerate_openfoam_reference_data.sh`

This will run each case in `target/openfoam_reference_runs/` and overwrite the CSV files under `tests/openfoam_reference/data/`.

The full-field probe lists are generated by:

- `scripts/openfoam/generate_probes_all_cfg.py`

## Case details

### Incompressible channel (`pimpleFoam`)

- Geometry: 2D channel, `L=1.0`, `H=0.2` (single cell thick in z, `empty` front/back).
- Mesh: `40 x 20`.
- BCs:
  - `U`: inlet `fixedValue (1 0 0)`, outlet `zeroGradient`, walls `noSlip`
  - `p`: inlet `zeroGradient`, outlet `fixedValue 0`, walls `zeroGradient`
- Model: laminar (`constant/turbulenceProperties`).
- Transport: kinematic viscosity `nu=0.01` (`constant/transportProperties`).
- Time stepping: `deltaT=0.02`, `endTime=1.6` (`system/controlDict`).
- Numerics:
  - `pimpleFoam` with a small PIMPLE loop (`system/fvSolution`).
- Sampling:
  - 20 probes placed at structured cell centers along `x=0.4875`, spanning `y=0.005..0.195`.
  - Full-field: 800 probes placed at all structured cell centers (`40x20`), written via a second `probesAll` function object.

### Compressible acoustic box (`rhoCentralFoam`)

- Geometry: 2D box, `L=1.0`, `H=0.05` (single cell thick in z, `empty` front/back).
- Mesh: `200 x 1`.
- BCs: slip walls (reflecting) on all 4 sides (`U` uses `slip`, `p` uses `zeroGradient`).
- Thermo:
  - Perfect gas (air-like), `T=300 K` (`constant/thermophysicalProperties`).
  - Dynamic viscosity `mu=1.81e-5`, `Pr=0.71`.
- Initial condition:
  - `p(x) = 101325 * (1 + 1e-3*cos(pi*x))` applied with `setExprFields` (`system/setExprFieldsDict`).
  - `U=0`, `T=300` initially.
- Time stepping:
  - Fixed `deltaT=1.7e-6`, `endTime=1.7e-4` (`system/controlDict`).
  - Kurganov (central-upwind) flux scheme (`system/fvSchemes`) to match the style of flux used by `cfd2`'s compressible solver.
- Sampling:
  - 200 probes placed at structured cell centers along the midline (`y=0.025`).
  - Full-field: identical to the midline for `Ny=1`, written via a second `probesAll` function object.

### Incompressible backwards step (`pimpleFoam`)

- Geometry: 2D backwards-facing step, `L=3`, `H_out=1`, `H_in=0.5`, `x_step=1` (single cell thick in z, `empty` front/back).
- Mesh: uniform `30 x 10` logical grid with an L-shaped domain (250 cells).
- BCs:
  - `U`: inlet `fixedValue (1 0 0)`, outlet `zeroGradient`, walls `noSlip`
  - `p`: inlet/walls `zeroGradient`, outlet `fixedValue 0`
- Sampling: full-field probes at all `cfd2`/OpenFOAM cell centers (250 points).

### Incompressible lid-driven cavity (`pimpleFoam`)

- Geometry: 2D cavity, `L=1`, `H=1` (single cell thick in z, `empty` front/back).
- Mesh: `20 x 20`.
- BCs:
  - `U`: lid `movingWallVelocity (1 0 0)`, other walls `noSlip`
  - `p`: all walls `zeroGradient`, gauge fixed via `pRefCell/pRefValue` in `system/fvSolution`
- Sampling: full-field probes at all structured cell centers (400 points).

### Compressible backwards step (`rhoCentralFoam`)

- Geometry/mesh: same as incompressible backwards step.
- Thermo: perfect gas (air-like), `T=300 K` (`constant/thermophysicalProperties`).
- Transport: dynamic viscosity `mu=1.81e-5`, `Pr=0.71`.
- BCs: inlet `U=(300 0 0)`, `p=101325`, `T=300`; outlet `zeroGradient`; walls `U=(0 0 0)`.
- Time stepping: `deltaT=2e-6`, `endTime=4e-4` (`system/controlDict`).
- Sampling: full-field probes at all cell centers (250 points).

### Compressible lid-driven cavity (`rhoCentralFoam`)

- Geometry/mesh: same as incompressible lid-driven cavity.
- Thermo: perfect gas (air-like), `T=300 K` (`constant/thermophysicalProperties`).
- Transport: dynamic viscosity `mu=1` (deliberately high), `Pr=0.71`.
- BCs: lid `U=(1 0 0)`; other walls `U=(0 0 0)`; `p`/`T` `zeroGradient` on all walls.
- Time stepping: `deltaT=1e-5`, `endTime=3e-3` (`system/controlDict`).
- Note: pressure perturbations are small (mean-free `p` is O(10–100 Pa)), so mean-free pressure comparisons are more meaningful than absolute `p≈101325` comparisons.
- Sampling: full-field probes at all cell centers (400 points).

### Compressible supersonic wedge (`rhoCentralFoam`)

- Geometry: 2D trapezoid, `L=1`, `H=0.6`, ramp rises to `h=0.2` at `x=L` (single cell thick in z, `empty` front/back).
- Mesh: `30 x 15` single block.
- Thermo: perfect gas (air-like), `T=300 K` (`constant/thermophysicalProperties`).
- Transport: dynamic viscosity `mu=1.81e-5`, `Pr=0.71`.
- BCs: inlet `U=(587 0 0)`, `p=101325`, `T=300`; outlet/top `zeroGradient`; ramp `U=(0 0 0)`.
- Time stepping: `deltaT=3.5e-7`, `endTime=7e-5` (`system/controlDict`).
- Sampling: full-field probes at all cell centers (450 points).

## Pseudo-transient / steady-state notes

The `cfd2` compressible solver supports pseudo-transient (dual-time-style) stepping via `dtau>0`.
In this mode, low-Mach preconditioning is intended to be enabled and can improve convergence for
low-Mach steady problems. Time-accurate OpenFOAM comparisons in the reference tests use `dtau=0`.
